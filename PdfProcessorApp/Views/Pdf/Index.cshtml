@{
    ViewBag.Title = "PDF İşlemleri";
    var fileName = ViewBag.FileName as string;
    var activeTool = ViewBag.ActiveTool as string ?? "view";
    var currentPdfPath = $"/uploads/{fileName}";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .sidebar {
        min-width: 220px;
        max-width: 220px;
        min-height: 400px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px 10px;
        margin-right: 24px;
    }

        .sidebar .nav-link.active {
            background: #0d6efd;
            color: #fff !important;
        }

    .pdf-viewer {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        min-height: 600px;
        background: #fff;
        padding: 16px;
    }

    .pdf-embed {
        width: 100%;
        height: 600px;
        border: none;
        border-radius: 8px;
        background: #f5f5f5;
    }

    .pdf-scroll-viewer {
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #f8f9fa;
        max-height: 700px;
        overflow-y: auto;
        padding: 16px;
    }

    .pdf-scroll-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 32px;
        position: relative;
        background: #fff;
        border: 1px solid #bbb;
        border-radius: 8px;
        box-shadow: 0 2px 8px #0001;
        padding: 12px 8px 16px 8px;
        width: fit-content;
        min-width: 320px;
        max-width: 100%;
    }

    .pdf-scroll-canvas {
        background: #fff;
        border-radius: 4px;
        max-width: 100%;
        margin-bottom: 8px;
    }

    .pdf-scroll-page-number {
        font-size: 15px;
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
        margin-top: 0;
        text-align: center;
        width: 100%;
    }

    .pdf-scroll-delete {
        margin-top: 8px;
        margin-bottom: 0;
        width: 100%;
    }
</style>

<div class="container mt-5">
    <h2 class="mb-4">PDF İşlemleri</h2>

    @if (TempData["Message"] != null && activeTool == null)
    {
        <div class="alert alert-info">@TempData["Message"]</div>
    }


    @if (fileName == null)
    {
        <form asp-action="UploadPdf" method="post" enctype="multipart/form-data" class="card p-4 mb-4 shadow-sm">
            <div class="mb-3">
                <label class="form-label">PDF Yükle</label>
                <input type="file" name="pdfFile" accept=".pdf" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">Yükle</button>
        </form>
    }
    else
    {
        <div class="row">
            <div class="col-md-3">
                <div class="sidebar">
                    <nav class="nav flex-column nav-pills" id="toolMenu">
                        <button class="nav-link @(activeTool == "view" ? "active" : "")" data-tool="view">PDF'i Görüntüle</button>
                        <button class="nav-link @(activeTool == "extractText" ? "active" : "")" data-tool="extractText">Metin Çıkar</button>
                        <button class="nav-link @(activeTool == "convertPdf" ? "active" : "")" data-tool="convertPdf">PDF Dönüştür</button>
                        <button class="nav-link @(activeTool == "deletePages" ? "active" : "")" data-tool="deletePages">Sayfa Sil</button>
                        <button class="nav-link @(activeTool == "mergePdf" ? "active" : "")" data-tool="mergePdf">PDF Birleştir</button>
                        <a href="@Url.Action("Index", "Pdf")" class="nav-link text-danger mt-3">Yeni PDF Yükle</a>
                    </nav>
                </div>
            </div>
            <div class="col-md-9">
                <div id="toolContent" class="pdf-viewer">

                    <div id="tool-view" class="tool-section @(activeTool == "view" ? "" : "d-none")">
                        <div class="mb-2">
                            <b>Yüklenen PDF:</b> @fileName
                        </div>
                        <embed src="@currentPdfPath" type="application/pdf" class="pdf-embed" />
                    </div>

                    <div id="tool-extractText" class="tool-section @(activeTool == "extractText" ? "" : "d-none")">
                        <form asp-action="ExtractText" method="post">
                            <input type="hidden" name="fileName" value="@fileName" />
                            <button type="submit" class="btn btn-outline-primary mb-3">Metin Çıkar</button>
                        </form>
                        @if (ViewBag.ExtractedText != null)
                        {
                            <div class="alert alert-light" style="white-space: pre-wrap; max-height: 400px; overflow:auto;">
                                @ViewBag.ExtractedText
                            </div>
                        }
                    </div>

                    <div id="tool-convertPdf" class="tool-section @(activeTool == "convertPdf" ? "" : "d-none")">
                        <form asp-action="ConvertPdf" method="post">
                            <input type="hidden" name="fileName" value="@fileName" />
                            <div class="mb-3">
                                <label class="form-label">Hedef Formatı Seçin</label>
                                <select name="targetFormat" class="form-select" required>
                                    <option value="">Seçiniz...</option>
                                    <option value="txt">TXT</option>
                                    <option value="docx">DOCX</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-outline-primary">Dönüştür</button>
                        </form>
                        @if (ViewBag.ConvertedFilePath != null)
                        {
                            var convertedFilePath = ViewBag.ConvertedFilePath as string;
                            var ext = System.IO.Path.GetExtension(convertedFilePath)?.ToLowerInvariant();
                            var label = ext == ".docx" ? "DOCX dosyasını indir" : ext == ".txt" ? "TXT dosyasını indir" : "Dosyayı indir";
                            <div class="alert alert-success mt-2">
                                <a href="@convertedFilePath" download>@label</a>
                            </div>
                        }
                        @if (ViewBag.Message != null && activeTool == "convertPdf")
                        {
                            <div class="alert alert-info mt-2">@ViewBag.Message</div>
                        }
                    </div>
                    
                    <div id="tool-deletePages" class="tool-section @(activeTool == "deletePages" ? "" : "d-none")">
                        @if (TempData["Message"] != null && activeTool == "deletePages")
                        {
                            <div class="alert alert-info mt-2">@TempData["Message"]</div>
                        }
                        <div id="pdf-scroll-viewer" class="pdf-scroll-viewer mb-3"></div>
                        <form id="deletePageForm" asp-action="DeletePage" method="post" style="display:none;">
                            <input type="hidden" name="fileName" value="@fileName" />
                            <input type="hidden" id="deletePageNumber" name="pageNumber" value="" />
                        </form>
                        <div class="alert alert-success mt-2">
                            <a href="@currentPdfPath" target="_blank" download>Güncel PDF'yi indir</a>
                        </div>
                    </div>

                   
                    <div id="tool-mergePdf" class="tool-section @(activeTool == "mergePdf" ? "" : "d-none")">
                        @if (TempData["Message"] != null && activeTool == "mergePdf")
                        {
                            <div class="alert alert-info mb-3">@TempData["Message"]</div>
                        }

                        <form asp-action="MergePdf" method="post" enctype="multipart/form-data" class="mb-3">
                            <input type="hidden" name="fileName" value="@fileName" />
                            <div class="mb-3">
                                <label class="form-label">Birleştirilecek PDF Dosyası</label>
                                <input type="file" name="fileToMerge" accept=".pdf" class="form-control" required />
                            </div>
                            <button type="submit" class="btn btn-primary">Birleştir</button>
                        </form>

                        @if (activeTool == "mergePdf")
                        {
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Birleştirilmiş PDF</h5>
                                        <a href="@currentPdfPath" class="btn btn-success btn-sm" download>
                                            <i class="bi bi-download"></i> İndir
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <embed src="@currentPdfPath" type="application/pdf" class="pdf-embed" />
                                </div>
                            </div>
                        }
                    </div>



                    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
                    <script>
                        if (window['pdfjsLib']) {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
                        }

                        let deletedPages = [];

                        function renderPdfScrollViewer() {
                            var url = "@currentPdfPath";
                            var container = document.getElementById('pdf-scroll-viewer');
                            container.innerHTML = "Yükleniyor...";

                            if (!window['pdfjsLib']) {
                                container.innerHTML = "pdf.js kütüphanesi yüklenemedi!";
                                return;
                            }

                            pdfjsLib.getDocument(url).promise.then(function (pdf) {
                                container.innerHTML = "";
                                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                                    if (deletedPages.includes(pageNum)) continue;

                                    pdf.getPage(pageNum).then(function (page) {
                                        var scale = 1.1;
                                        var viewport = page.getViewport({ scale: scale });
                                        var canvas = document.createElement('canvas');
                                        canvas.className = "pdf-scroll-canvas";
                                        canvas.width = viewport.width;
                                        canvas.height = viewport.height;
                                        var context = canvas.getContext('2d');
                                        page.render({ canvasContext: context, viewport: viewport }).promise.then(function () {
                                            var wrapper = document.createElement('div');
                                            wrapper.className = "pdf-scroll-page";
                                            wrapper.setAttribute('data-page', pageNum);

                                            var label = document.createElement('div');
                                            label.className = "pdf-scroll-page-number";
                                            label.innerText = "Sayfa " + pageNum;
                                            wrapper.appendChild(label);

                                            wrapper.appendChild(canvas);

                                            var btn = document.createElement('button');
                                            btn.className = "btn btn-outline-danger btn-sm pdf-scroll-delete";
                                            btn.innerText = "Bu sayfayı sil";
                                            btn.onclick = function (e) {
                                                e.preventDefault();
                                                if (confirm(pageNum + ". sayfayı silmek istediğinize emin misiniz?")) {
                                                    document.getElementById('deletePageNumber').value = pageNum;
                                                    deletedPages.push(pageNum);
                                                    var pageDiv = container.querySelector('[data-page="' + pageNum + '"]');
                                                    if (pageDiv) pageDiv.remove();
                                                    document.getElementById('deletePageForm').submit();
                                                }
                                            };
                                            wrapper.appendChild(btn);

                                            container.appendChild(wrapper);
                                        });
                                    }).catch(function (err) {
                                        container.innerHTML += "<div class='text-danger'>Sayfa " + pageNum + " yüklenemedi: " + err.message + "</div>";
                                    });
                                }
                            }).catch(function (error) {
                                container.innerHTML = "<div class='text-danger'>PDF yüklenemedi: " + error.message + "</div>";
                            });
                        }

                        function setupDeletePagesTab() {
                            var deleteBtn = document.querySelector('[data-tool="deletePages"]');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', function () {
                                    setTimeout(renderPdfScrollViewer, 100);
                                });
                            }
                        }

                        document.addEventListener("DOMContentLoaded", function () {
                            if ("@activeTool" === "deletePages") {
                                renderPdfScrollViewer();
                            }
                            setupDeletePagesTab();
                        });
                    </script>

                    
                </div>
            </div>
        </div>
    }
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var menu = document.getElementById("toolMenu");
        if (menu) {
            menu.querySelectorAll(".nav-link").forEach(function (btn) {
                btn.addEventListener("click", function (e) {
                    if (btn.tagName === "A") return;
                    menu.querySelectorAll(".nav-link").forEach(x => x.classList.remove("active"));
                    btn.classList.add("active");
                    var tool = btn.getAttribute("data-tool");
                    document.querySelectorAll(".tool-section").forEach(function (sec) {
                        sec.classList.add("d-none");
                    });
                    var active = document.getElementById("tool-" + tool);
                    if (active) active.classList.remove("d-none");
                });
            });
        }
    });

</script>
